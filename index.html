<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Erdarbeiten – Kosten pro m³ vs. Leistung</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root { --bg:#f7f8fb; --card:#ffffff; --text:#0f172a; --muted:#64748b; --accent:#111827; --border:#e5e7eb; }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
         color:var(--text); background: linear-gradient(180deg,#ffffff 0%,#f5f7fb 100%); }
  .container { display:grid; grid-template-columns: 340px 1fr; gap:16px; height:100vh; padding:16px; }
  .panel { background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 20px rgba(0,0,0,0.03); display:flex; flex-direction:column; overflow:hidden; }
  .panel h2 { font-size:16px; font-weight:600; margin:0; padding:14px 16px; border-bottom:1px solid var(--border); background:#fff; }
  .panel .content { padding:14px 16px; overflow:auto; }
  .group-title { font-size:13px; font-weight:600; color:var(--text); margin:10px 0 6px; }
  label { display:block; font-size:12px; color:var(--muted); margin-top:8px; }
  input[type="number"] { width:100%; padding:10px 10px; margin-top:6px; border:1px solid var(--border); border-radius:10px; font-size:14px; }
  input[type="checkbox"] { transform: translateY(2px); margin-right:6px; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  .full { grid-column: 1 / -1; }
  .btn { display:inline-flex; align-items:center; gap:8px; background:var(--accent); color:#fff; border:0; padding:10px 14px; border-radius:10px; font-size:14px; cursor:pointer; }
  .chart-panel { padding: 10px 14px; height: calc(100vh - 32px); }
  #chart { width: 100%; height: calc(100% - 82px); }
  .header { display:flex; align-items:baseline; justify-content:space-between; gap:8px; margin-bottom:8px; }
  .header h1 { font-size: 18px; margin:0; }
  .header .sub { color:#64748b; font-size:12px; }
  .help { font-size: 12px; color:#64748b; margin-top:6px; }
  .kpis { display:flex; gap:16px; font-size:13px; color:#0f172a; margin:6px 0; }
  .kpis .val { font-weight:600; }
  .range-row { display:flex; align-items:center; gap:10px; margin-top:6px; }
  .range-row input[type="range"] { flex: 1; }
  .minmax { width:64px; text-align:center; font-size:12px; color:#64748b; }
  .btn-small { padding:6px 10px; font-size:12px; }
  .btn-ghost { background:transparent; color:var(--accent); border:1px solid var(--border); }
</style>
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="panel">
      <h2>Einstellungen</h2>
      <div class="content">
        <div class="group">
          <div class="group-title">Projekt</div>
          <div class="row">
            <label>€/cbm Aushub<input id="salePrice" type="number" step="0.01" value="1.5"></label>
            <label>Entsorgung (€/cbm)<input id="disposalPerM3" type="number" step="0.01" value="0"></label>
          </div>
          <div class="row">
            <label>Volumen (cbm)<input id="projectVolume" type="text" inputmode="numeric" value="100000"></label>
            <label class="full">Projektfixkosten (€)<input id="projectFixed" type="number" step="1" value="0"></label>
          </div>
          <label><input id="includeProjectFixedInChart" type="checkbox"> Chart inkl. Projektfixkosten</label>
        </div>

        <div class="group">
          <div class="group-title">Kosten</div>
          <div class="row">
            <label>Personal (€/h)<input id="personalHourly" type="number" step="0.01" value="22"></label>
            <label>Std/Tag<input id="hoursPerDay" type="number" step="1" value="8"></label>
          </div>
          <label class="full">Effizienz (0.6–1.0)<input id="efficiency" type="number" step="0.01" min="0.6" max="1.0" value="1.0"></label>
        </div>

        <div class="group">
          <div class="group-title">Maschinen</div>
          <div class="row">
            <label class="full">Maschine wählen
              <select id="machineSelect"></select>
            </label>
          </div>
          <div class="row">
            <button id="addMachineBtn" class="btn btn-small" type="button">Maschine hinzufügen</button>
          </div>
          <div class="row">
            <label class="full">€/h Gerät<input id="machineHourly" type="number" step="0.01"></label>
          </div>
          <div class="row">
            <label>min (cbm/h)<input id="machineMin" type="number" step="0.1"></label>
            <label>max (cbm/h)<input id="machineMax" type="number" step="0.1"></label>
          </div>
          <label class="full">Projekt-Leistung (cbm/h) je Maschine</label>
          <div id="projectSliders"></div>
          <div class="help">Sichtbarkeit der Maschinen im Diagramm:</div>
          <div id="machineList"></div>
        </div>

        <div style="margin-top: 10px; display:flex; gap:8px; align-items:center;">
          <button id="exportBtn" class="btn">CSV exportieren</button>
          <button id="resetBtn" class="btn btn-small btn-ghost" type="button">Zurücksetzen</button>
          <div class="help">Tipp: Rechtsklick → „Link speichern unter…“, falls der Browser den Download blockiert.</div>
        </div>
      </div>
    </div>

    <div class="panel chart-panel">
      <div class="header">
        <h1>Kosten pro m³ (X) vs. Leistung cbm/h (Y)</h1>
        <div class="sub">Rote Linie = VK+Entsorgung €/m³</div>
      </div>
      <div class="kpis" id="kpiBar" style="display:flex;">
        <div>Umsatz/h: <span id="kpiRevenue" class="val">–</span></div>
        <div>Kosten/h: <span id="kpiCost" class="val">–</span></div>
        <div>DB/h: <span id="kpiDB" class="val">–</span></div>
      </div>
      <div id="chart"></div>
    </div>
  </div>

<script>
function num(id){ return parseFloat(document.getElementById(id).value || '0'); }
function bool(id){ return document.getElementById(id).checked; }

const fmt2 = new Intl.NumberFormat('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

function costPerM3(q, machineHourly, personalHourly, efficiency){
  const perHour = Number(machineHourly) + Number(personalHourly);
  return perHour / (Number(q) * Number(efficiency || 1));
}

function computeSeries(qmin, qmax, machineHourly, personalHourly, efficiency, includeProjectFixedInChart, projectFixedPerM3){
  const step = Math.max(0.1, (qmax - qmin) / 800);
  const xs = [], ys = [], texts = [];
  for(let q = qmin; q <= qmax + 1e-9; q = Math.round((q + step)*10000)/10000){
    const perHour = Number(machineHourly) + Number(personalHourly);
    let x = perHour / (Number(q) * Number(efficiency || 1));
    if (includeProjectFixedInChart) x += projectFixedPerM3;
    xs.push(x);
    ys.push(q);
    texts.push(`Kosten: ${fmt2.format(x)} € pro m³<br>Leistung: ${fmt2.format(q)} cbm/h<br>Kosten/h: ${fmt2.format(perHour)} €`);
  }
  return { xs, ys, texts };
}

const machines = [
  { id: 'm15', name: '15t', hourly: 38.84, min: 2.4, max: 100, show: true, projectQ: 2.4 },
  { id: 'm20', name: '20t', hourly: 42.53, min: 3.0, max: 125, show: true, projectQ: 3.0 },
  { id: 'm27', name: '27t', hourly: 58.03, min: 3.6, max: 150, show: true, projectQ: 3.6 },
];

const STORAGE_KEY = 'erdarbeiten_settings_v1';

function getSelectedMachine(){
  const sel = document.getElementById('machineSelect');
  return machines.find(m => m.id === sel.value) || machines[0];
}

function renderMachineSelect(){
  const sel = document.getElementById('machineSelect');
  sel.innerHTML = '';
  for(const m of machines){
    const opt = document.createElement('option');
    opt.value = m.id; opt.textContent = m.name;
    sel.appendChild(opt);
  }
  if(!sel.value && machines[0]) sel.value = machines[0].id;
}

function renderMachineList(){
  const cont = document.getElementById('machineList');
  cont.innerHTML = '';
  for(const m of machines){
    const id = `show_${m.id}`;
    const label = document.createElement('label');
    label.style.display = 'block';
    const cb = document.createElement('input');
    cb.type = 'checkbox'; cb.id = id; cb.checked = m.show;
    cb.addEventListener('change', () => { m.show = cb.checked; renderProjectSliders(); update(); });
    label.appendChild(cb);
    label.appendChild(document.createTextNode(` ${m.name}`));
    cont.appendChild(label);
  }
}

function loadSelectedMachineIntoForm(){
  const m = getSelectedMachine();
  if(!m) return;
  const hourly = document.getElementById('machineHourly');
  const min = document.getElementById('machineMin');
  const max = document.getElementById('machineMax');
  hourly.value = m.hourly;
  min.value = m.min;
  max.value = m.max;
  renderProjectSliders();
}

function addMachine(){
  const name = prompt('Name der Maschine (z. B. 35t):', 'Neue Maschine');
  if(!name) return;
  const id = 'm' + Math.random().toString(36).slice(2,8);
  machines.push({ id, name, hourly: 0, min: 1, max: 100, show: true, projectQ: 1 });
  renderMachineSelect();
  renderMachineList();
  document.getElementById('machineSelect').value = id;
  loadSelectedMachineIntoForm();
  renderProjectSliders();
  update();
}

function update(){
  const settings = {
    salePrice: num('salePrice'),
    disposalPerM3: num('disposalPerM3'),
    projectVolume: (function(){
      const raw = document.getElementById('projectVolume').value.trim();
      const norm = raw.replace(/\./g, '').replace(/,/g, '.');
      const v = parseFloat(norm || '0');
      if(!isFinite(v)) return 0;
      return v;
    })(),
    projectFixed: num('projectFixed'),
    includeProjectFixedInChart: bool('includeProjectFixedInChart'),
    personalHourly: num('personalHourly'),
    hoursPerDay: num('hoursPerDay'),
    efficiency: num('efficiency'),
  };
  const projectFixedPerM3 = settings.projectVolume > 0 ? settings.projectFixed / settings.projectVolume : 0;

  const visible = machines.filter(m => m.show);
  // keep selected machine projectQ in case slider hidden/shown
  if(visible.length === 0 && machines.length) { /* nothing visible */ }
  const selected = getSelectedMachine();
  const traces = [];
  for(const m of visible){
    const s = computeSeries(m.min, m.max, m.hourly, settings.personalHourly, settings.efficiency, settings.includeProjectFixedInChart, projectFixedPerM3);
    traces.push({ x: s.xs, y: s.ys, text: s.texts, hovertemplate: '%{text}<extra>%{fullData.name}</extra>', name: m.name, mode: 'lines', line: { width: 3 } });
  }

  let xmin = Infinity, xmax = -Infinity;
  for(const t of traces){
    for(const v of t.x){ if (isFinite(v)) { if(v<xmin)xmin=v; if(v>xmax)xmax=v; } }
  }
  if(!isFinite(xmin) || !isFinite(xmax)){ xmin = 0; xmax = 1; }
  const lo = Math.floor(xmin);
  const hi = Math.ceil(xmax);
  const tickvals = [];
  for(let v=lo; v<=hi; v++){ tickvals.push(v); }
  const ticktext = tickvals.map(v => fmt2.format(v));

  const perHourSelected = selected ? (Number(selected.hourly) + Number(settings.personalHourly)) : null;
  const layout = {
    margin: { t: 10, r: 30, b: 50, l: 60 },
    xaxis: { title: 'Kosten [€/m³]', tickmode: 'array', tickvals, ticktext, range: [lo, hi] },
    yaxis: { title: 'Leistung [cbm/h]', tick0: 0, dtick: 10 },
    hovermode: 'closest',
    shapes: [
      { type: 'line', x0: (settings.salePrice + settings.disposalPerM3), x1: (settings.salePrice + settings.disposalPerM3), y0: 0, y1: 1, xref: 'x', yref: 'paper', line: { dash: 'dash', width: 2, color: '#ef4444' } }
    ],
    legend: { orientation: 'h', x: 0, y: 1.05 },
    annotations: [
      ...(perHourSelected != null ? [
        { xref: 'paper', yref: 'paper', x: 0.01, y: 0.98, xanchor: 'left', yanchor: 'top',
          text: `Kosten/h (${selected.name}): <b>${fmt2.format(perHourSelected)} €</b>`, showarrow: false, align: 'left', font: { size: 12 } }
      ] : []),
      { xref: 'x', yref: 'paper', x: (settings.salePrice + settings.disposalPerM3), y: 1.02, xanchor: 'center', yanchor: 'bottom',
        text: `VK+Entsorgung: <b>${fmt2.format(settings.salePrice + settings.disposalPerM3)} €</b>`, showarrow: false, font: { size: 12, color: '#ef4444' } }
    ]
  };

  Plotly.react('chart', traces, layout, {responsive: true, displayModeBar: true});
  updateKpis();
  saveState();
}

function renderProjectSliders(){
  const wrap = document.getElementById('projectSliders');
  wrap.innerHTML = '';
  for(const m of machines){
    if(!m.show) continue;
    const row = document.createElement('div');
    row.className = 'range-row';
    const minLbl = document.createElement('div'); minLbl.className = 'minmax'; minLbl.textContent = fmt2.format(m.min);
    const maxLbl = document.createElement('div'); maxLbl.className = 'minmax'; maxLbl.textContent = fmt2.format(m.max);
    const slider = document.createElement('input'); slider.type = 'range'; slider.min = m.min; slider.max = m.max; slider.step = 0.1; slider.value = m.projectQ;
    const help = document.createElement('div'); help.className = 'help'; help.textContent = `${m.name}: ${fmt2.format(m.projectQ)} cbm/h`;
    slider.addEventListener('input', (e) => { m.projectQ = Number(e.target.value||0); help.textContent = `${m.name}: ${fmt2.format(m.projectQ)} cbm/h`; updateKpis(); });
    const line = document.createElement('div'); line.style.display='flex'; line.style.alignItems='center'; line.style.gap='10px';
    line.appendChild(minLbl); line.appendChild(slider); line.appendChild(maxLbl);
    row.appendChild(line);
    row.appendChild(help);
    wrap.appendChild(row);
  }
}

function updateKpis(){
  const m = getSelectedMachine();
  if(!m){ document.getElementById('kpiRevenue').textContent = '–'; document.getElementById('kpiDB').textContent = '–'; document.getElementById('kpiBar').style.display='none'; return; }
  document.getElementById('kpiBar').style.display='flex';
  const salePrice = num('salePrice') + num('disposalPerM3');
  const personalHourly = num('personalHourly');
  const revenuePerHour = salePrice * m.projectQ;
  const costPerHour = m.hourly + personalHourly;
  const dbPerHour = revenuePerHour - costPerHour;
  document.getElementById('kpiRevenue').textContent = fmt2.format(revenuePerHour) + ' €';
  document.getElementById('kpiCost').textContent = fmt2.format(costPerHour) + ' €';
  document.getElementById('kpiDB').textContent = fmt2.format(dbPerHour) + ' €';
}

function exportCSV(){
  const salePrice = num('salePrice'); // not used but kept for context
  const projectVolume = num('projectVolume');
  const projectFixedPerM3 = projectVolume > 0 ? num('projectFixed') / projectVolume : 0;
  const includeProjectFixedInChart = bool('includeProjectFixedInChart');
  const personalHourly = num('personalHourly');
  const efficiency = num('efficiency');
  const visible = machines.filter(m => m.show);
  const headers = ['cbm/h', ...visible.map(m => `${m.name} €/m³`)];
  const series = visible.map(m => {
    const step = Math.max(0.1, (m.max - m.min) / 800);
    const rows = [];
    for(let q = m.min; q <= m.max + 1e-9; q = Math.round((q + step)*10000)/10000){
      let x = costPerM3(q, m.hourly, personalHourly, efficiency);
      if (includeProjectFixedInChart) x += projectFixedPerM3;
      rows.push([q, x]);
    }
    return rows;
  });
  let csv = headers.join(',') + '\n';
  const maxLen = Math.max(...series.map(s => s.length), 0);
  for(let i=0;i<maxLen;i++){
    const q = series[0]?.[i]?.[0] ?? '';
    const row = [q, ...series.map(s => s?.[i]?.[1] ?? '')];
    csv += row.join(',') + '\n';
  }
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'erdarbeiten_kosten_kurven.csv'; a.click();
  URL.revokeObjectURL(url);
}

function bind(){
  // global settings
  ['salePrice','projectVolume','projectFixed','includeProjectFixedInChart','personalHourly','hoursPerDay','efficiency']
    .forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('input', update);
      el.addEventListener('change', update);
    });

  // format Volumen with de-DE grouping while typing (best-effort)
  const volEl = document.getElementById('projectVolume');
  volEl.addEventListener('blur', () => {
    const raw = volEl.value.trim();
    const norm = raw.replace(/\./g, '').replace(/,/g, '.');
    const v = parseFloat(norm || '0');
    if(isFinite(v)) volEl.value = new Intl.NumberFormat('de-DE', { maximumFractionDigits: 0 }).format(v);
  });

  // machines ui
  document.getElementById('addMachineBtn').addEventListener('click', addMachine);
  document.getElementById('machineSelect').addEventListener('change', () => { loadSelectedMachineIntoForm(); updateKpis(); });
  document.getElementById('machineHourly').addEventListener('input', (e) => { const m = getSelectedMachine(); if(m){ m.hourly = Number(e.target.value||0); renderProjectSliders(); update(); } });
  document.getElementById('machineMin').addEventListener('input', (e) => { const m = getSelectedMachine(); if(m){ m.min = Number(e.target.value||0); if(m.projectQ < m.min) m.projectQ = m.min; renderProjectSliders(); update(); } });
  document.getElementById('machineMax').addEventListener('input', (e) => { const m = getSelectedMachine(); if(m){ m.max = Number(e.target.value||0); if(m.projectQ > m.max) m.projectQ = m.max; renderProjectSliders(); update(); } });

  document.getElementById('exportBtn').addEventListener('click', exportCSV);
  document.getElementById('resetBtn').addEventListener('click', resetState);

  renderMachineSelect();
  renderMachineList();
  loadSelectedMachineIntoForm();
  renderProjectSliders();
  update();
}

function saveState(){
  try{
    const state = {
      salePrice: num('salePrice'),
      disposalPerM3: num('disposalPerM3'),
      projectVolume: document.getElementById('projectVolume').value,
      projectFixed: num('projectFixed'),
      includeProjectFixedInChart: bool('includeProjectFixedInChart'),
      personalHourly: num('personalHourly'),
      hoursPerDay: num('hoursPerDay'),
      efficiency: num('efficiency'),
      machines
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }catch(e){ /* ignore */ }
}

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const s = JSON.parse(raw);
    document.getElementById('salePrice').value = s.salePrice ?? 1.5;
    document.getElementById('disposalPerM3').value = s.disposalPerM3 ?? 0;
    document.getElementById('projectVolume').value = s.projectVolume ?? '100000';
    document.getElementById('projectFixed').value = s.projectFixed ?? 0;
    document.getElementById('includeProjectFixedInChart').checked = !!s.includeProjectFixedInChart;
    document.getElementById('personalHourly').value = s.personalHourly ?? 22;
    document.getElementById('hoursPerDay').value = s.hoursPerDay ?? 8;
    document.getElementById('efficiency').value = s.efficiency ?? 1.0;
    if(Array.isArray(s.machines) && s.machines.length){
      machines.length = 0;
      for(const m of s.machines){ machines.push(m); }
    }
  }catch(e){ /* ignore */ }
}

function resetState(){
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
}

window.addEventListener('DOMContentLoaded', bind);
window.addEventListener('DOMContentLoaded', () => { loadState(); renderMachineSelect(); renderMachineList(); renderProjectSliders(); update(); });
</script>
</body>
</html>
